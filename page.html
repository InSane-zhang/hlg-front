<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta charset="utf-8"/>

<script src="http://a.tbcdn.cn/s/kissy/1.2.0/??kissy-min.js"> </script>
<script src="<?php echo Hlg::getCdnUrl();?>js/hlg/v3/common/package-config.js?t=<?php echo date('YmdHis');?>"></script>
<script type="text/javascript">
    var TRACK_URL = '<?php echo $this->getUrl('core/index/saveTrack'); ?>';  //链接跟踪地址
    var S = KISSY, DOM = S.DOM,Event = S.Event;	doc = document;
    KISSY.config({
        map:[
		[/(.+1.0\/.+)<?php echo empty($isMin)?'-min':'';?>.js(\?[^?]+)?$/, "$1.js$2"]   
         ]
    });
    window.config = {
    	      oldpath: '<?php echo Hlg::getCdnUrl();?>js/hlg/version-2', // 兼容旧的调用方式
              path:'<?php echo Hlg::getCdnUrl();?>js/hlg/v3',   // 基路径（模块路径寻址的基点）
              version:'1.0',   // 源码目录名（fb的目录约定版本号目录即源码目录），也会拼入模块js路径中
              debug: true,
    	      name: '<?php echo 'M'.$ModuleNam;?>', // 模块名称 和php 后台一致 比如 Mcore Mpromotion 
    	       pub:window.PAGECONFIG.<?php echo 'M'.$ModuleNam;?> ? window.PAGECONFIG.<?php echo 'M'.$ModuleNam;?> : window.PAGECONFIG.pub  // 发布目录 ，默认使用 全局 个别模块更新 再配置
    }
    FB.config(config);
</script>
// 保留H 命名空间 和一些基本函数 ，只有 倒计时 新版弹出框 异步封装 三种组件 ，其他 的根据 具体模块引入
<script src="<?php echo Hlg::getCdnUrl();?>js/hlg/v3/common/base<?php echo $isMin?>.js?t=<?php echo $versionTime;?>" type="text/javascript" ></script>

<script src="<?php echo Hlg::getCdnUrl();?>js/swfobject/swfobject.js" type="text/javascript" ></script>
// 删除 哪个页面需要使用图表 在哪个页面底部添加 
<?php if (in_array($ModuleNam,array('udp','point','promoprops','tool'))):?>
<script src="<?php echo Hlg::getCdnUrl();?>js/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="<?php echo Hlg::getCdnUrl();?>js/hlg/highcharts.js" type="text/javascript" ></script>
<?php endif;?>	sdf
</head>
<body>





具体 页面 模块 使用 直接
比如 这个 是 活动 列表页   模块名 为  Mpromotion  会调用  page/1.0/list-init.js
KISSY.ready(function(S){
 	 KISSY.use('page/list-init',function(S,promotionControl){
 		promotionControl.init()
	 })
})




<script type="text/javascript">
// 子账号权限
var showPermissions = function(app,type){
	//str = 'view_promo,view_promotion,view_promodesc,view_icon,view_smart,view_fuzhu,view_material,view_crm,view_tool,editor_promo,editor_promotion,editor_promodesc,editor_icon,editor_smart,editor_fuzhu,editor_material,editor_crm,editor_tool'
	var type = type || "查看此";
	var str = DOM.val('#J_Permissions');
	<?php 
		$coreShop = Hlg::getModel('core/shop')->load(Hlg::getShop()->getId());
		$shopType = $coreShop->getData('type');	
		$now = date('Y-m-d H:i:s');
         if(($now >= '2012-11-10 22:25:00') && ($now <= '2012-11-11 00:00:00')&& ($shopType == 'B')): 
    ?>
	if(str.search(app) < 0){
		new H.widget.msgBox({
		    title:"温馨提示",
		    content:'由于淘宝优惠系统崩溃，11号2点半之前促销活动不可用，请亲们谅解',
		    type:"info"
		});
		return false;
	}else{
		return true;
	}
	<?php else:?>
	var isRoot = DOM.val('#J_IsRoot');
	if(str == 3 || isRoot == 1){
		return true;
	}
	if(str.search(app) < 0){
		new H.widget.msgBox({
		    title:"错误提示",
		    content:'很抱歉您没有权限'+type+'模块，你可以联系主帐号更改权限。<a href="<?php echo $this->getUrl('sub/index/view');?>">查看权限</a>&nbsp;&nbsp;&nbsp;<a target="_blank" href="http://bangpai.taobao.com/group/thread/609027-274530900.htm">查看教程</a>',
		    type:"info"
		});
		return false;
	}else{
		return true;
	}
	<?php endif;?>
}
//版本控制   app 模块名  type  是否弹框（如果 试用的话 就自己弹框，）
var isVersionPer = function(app,type){
		  var flag = DOM.val('#J_IsRoot');
		  var type = type || false;
		  var result = [];	
		  var versionBody = DOM.html("#zunxiang");
		  var Time = DOM.html("#J_times");
		  var shopId = DOM.val('#J_ShopId');
		  var isOk = false;  //有权限
		  var body = '';
		  switch (flag){
		  	case '1' :
								 //一件优惠 ，一口价，团购， 免邮          ，满就送，阶梯价，限购           ，  限时折扣， 满就送彩票  
				var	activeIds = ['onetbspec','spec','tg','freepost','mjs','jtj','buyerlimit','tbspec', 'mjscp'];
			break;
			case '2' :
				/*【工具箱】免费版标准版（shopid>108250 的标准版）提示升级尊享版*/
			  	if(shopId > 108250){
					var	activeIds = ['onetbspec','spec','tg','freepost','mjs','jtj','buyerlimit','tbspec', 'mjscp','promodesc','icon','smart'];
				}else{
									//一件优惠 ，一口价，团购， 免邮          ，满就送，阶梯价，限购           ，  限时折扣， 满就送彩票   详情                    图标		店铺模块 ，工具箱
					var	activeIds = ['onetbspec','spec','tg','freepost','mjs','jtj','buyerlimit','tbspec', 'mjscp','promodesc','icon','smart','tool'];
				}
			break;
			case '3' :
				var	activeIds = ['onetbspec','spec','tg','freepost','mjs','jtj','buyerlimit','tbspec', 'mjscp','promodesc','icon','smart','tool'];
			break;
			default:
				var	activeIds = ['onetbspec','spec','tg','freepost','mjs','jtj','buyerlimit','tbspec', 'mjscp','promodesc','icon','smart','tool'];
			break;
		  }
		  if(flag != 3){
			if(!KISSY.inArray(app, activeIds)){
					if(type){
						KISSY.use("node,overlay", function(S, Node, O ) {
							var d = new O.Dialog({
							      width: 879,
							      headerContent: '',
							      bodyContent: '<div style="padding-bottom:5px;"><img src="http://cdn.huanleguang.com/img/hlg/v3/sorry.jpg"/></div><div style="font-size:14px;margin-bottom: 15px;">该功能仅针对尊享版用户开放，您可以通过下面优惠升级</div>'+versionBody+'<div style="background-color:#f5f5f5;color:#999;height:40px; line-height:40px;padding-left:50px;margin: 30px -50px -20px -50px;">'+Time+'</div>',
							      mask: true,
							      align: {
							          points: ['cc', 'cc']
							      },
							      closable :true,
							      draggable: true,
							      aria:true
							  });
							d.render();
							d.show();
							DOM.style('.ks-stdmod-header',{background:'white',border:'0'});
							DOM.style('.ks-dialog',{width:DOM.width('.order-btn')+50,padding:'0px 50px 20px 50px',border:'0'});
							DOM.style('.ui-dialog-mask',{background:'black',opacity:'0.5'});
						})
					}
					isOk = true;
  				}
		  }
		 return isOk; 
	}
// 判断授权时间
var IsExpired = function(cTime){
	//电脑时间 和系统时间 相差 10秒以内 结束时间 以系统为尊，否则  结束时间 需要调整
	var w2Expired = H.util.StringToDate(DOM.val('#J_W2Expired')), 
		w2Curtime = H.util.StringToDate(DOM.val('#J_W2Curtime'));
		var DiffTime = localTime.getTime() - w2Curtime.getTime();
		var cTime = cTime || new Date();
		var isPass = false;
		if(Math.abs(DiffTime) > 10000){
			w2Expired = new Date(w2Expired.getTime() + (Number(DiffTime)));	
		}
		return cTime.getTime() - w2Expired.getTime();
} 
KISSY.ready(function(S){
	 var DOM = S.DOM ,Event =S.Event;
	 
	// 页面公共函数 执行  头部 和 左边栏 
	 S.use('common/main');

	//链接跟踪  需要跟踪连接的 直接 加 data-track 
	 var $ = S.Node.all;
     $('body').on('click', function(ev){
           var $et = $(ev.target);
           var trackType = $et.attr('data-track');
           if (trackType) {
			 	S.io.get(TRACK_URL,{
			    name:trackType
			});
           }
     });


	//授权弹出框
	 Event.delegate(document,'click','.J_TopExpired', function(ev) {
		 	if(window.popupExpired){
		 		window.popupExpired.hide();
			}
			var URl = DOM.attr(ev.currentTarget,'data');
			KISSY.use("node,overlay", function(S, Node, O ) {
				window.TopExpiredPanel = new O.Dialog({
				      width: 500,
				      headerContent: '淘宝授权窗口&nbsp;&nbsp;&nbsp;&nbsp;<a href="#2" onclick="window.open(\''+URl+'\',\'J_TopExpiredIframe\')" >刷新</a>',
				      bodyContent: '<div class="J_Iframe"><iframe name="J_TopExpiredIframe"  id="J_TopExpiredIframe"  src="" marginwidth="0" marginheight="0" scrolling="no"  frameborder="0" WIDTH="520" height="700"  ></iframe><div>',
				      mask: false,
				      align: {
				          points: ['cc', 'cc']
				      },
				      closable :true,
				      draggable: true,
				      aria:true
				  });
				window.TopExpiredPanel.render();
				var blocked = false; 
				try {    
					 var wroxWin = window.open(URl,'J_TopExpiredIframe');     
					 if (wroxWin == null) {        
					 	blocked = true;     
					 } 
				} catch (ex) {     
					blocked = true; 
				} 
				if (blocked) {
					new O.Dialog({
					      width: 365,
					      headerContent: '温馨提示',
					      bodyContent: '<div class="point relative"><div class="point-w-1">亲，授权窗口被浏览器拦截了&nbsp;&nbsp;&nbsp;<a target="_blank" href="http://bangpai.taobao.com/group/thread/609027-275734689.htm">点此查看</a></div></div>',
					      mask: true,
					      align: {
					          points: ['cc', 'cc']
					      },
					      closable :true,
					      draggable: true,
					      aria:true
					  });
					return ;
				}
				window.TopExpiredPanel.show();
			    window.TopExpiredPanel.get('el').attr('id','J_TopExpiredme');
				window.TopExpiredPanel.show();
				window.TopExpiredPanel.on('hide',function(){
					var diff  = IsExpired();
	       			if(diff > -5000){
	       				return ;
		       		}
				<?php if(strtolower($module) == 'promotion'):?>
						<?php if(strtolower($action) == 'create' || strtolower($action) == 'editPromo'):?>
							KISSY.Event.fire('#J_BtnPublish','click'); 
						<?php elseif (strtolower($action) == 'item'):?>
							var type = DOM.val('#J_ExpiredActionType');
							switch(type){
								case 'addItem' :
									var id = DOM.attr('#J_ExpiredActionType','data');
									H.promotion.addSelectItemsToPromotion(id);
								break;
								case 'addItems' :
									H.promotion.addSelectItemsToPromotion();
								break;
								case 'batchAdd' :
									H.promotion.batchAddItems();
								break;
								case 'editorOne' :
									var idd = DOM.attr('#J_ExpiredActionType','data');
									H.promotion.editItem(idd);
								break;
								case 'editorAll' :
									H.promotion.editPromoItem();
								break;
								case 'restartOne' :
									var idd = DOM.attr('#J_ExpiredActionType','data');
									var pidd = DOM.attr('#J_ExpiredActionType','pid');
									H.promotion.restartPromotionItemHandle(idd,pidd)
								break;
								case 'restartAll' :
									H.promotion.restartPromotionItemHandle();
								break;
								case 'batchRetryAll' :
									H.promotion.batchRetry();
								break;
								default :
								break;	
							}
						<?php elseif (strtolower($action) == 'range'):?>
							var id = DOM.val('#J_ExpiredActionType');
							if(id == '1'){
	         					H.range.addSelectItemsToRange();
	         				}else{
	         					H.range.addSelectItemsToRange(id);
	         				}
						<?php endif;?>
				
					<?php endif;?>

				})
				
			})
  	});
<!--	<?php //if(Hlg::getShop()->getId() == '44281'):?>-->
//	KISSY.Event.fire('.J_TopExpired','click');
<!--	<?php //endif;?>-->
	 	
	 Event.delegate(document,'click','.lijishouquan', function(ev) {
		 KISSY.Event.fire('.J_TopExpired','click');
	 });

	window.popupExpired = null;
	 var getAuthTaskInfo = function(){
			KISSY.io({
		        url:'<?php echo $this->getUrl('core/index/getAuthTaskInfoAjax');?>',
		        type:'get',
		        dataType:'json',
		        success:function(o,s,xhr){
					if(o.payload.taskNum > 0 && o.payload.desc){
							if(!window.popupExpired){
								var cont =  '<div id="shouquan"><div class=""   style=" padding: 10px 0 0 10px;" >'+
											'<span  style="display:block;" id="J_ProcessPromo1">'+o.payload.body+'</span>'+
					           				'<span class="shouquan margin-auto" style=" padding: 10px;display:block;">'+
					             				'<a  href="#2"><span class="lijishouquan J_MustExpired" ></span></a>'+
					             			'<a target="_blank" href="http://bangpai.taobao.com/group/thread/609027-269973566.htm"><span style="float:right; padding-right:15px; color:#ff7a00;">为什么要授权？</span></a>'+
					           				'</span>'+
					   	 				'</div></div>';
								KISSY.use("node,overlay", function(S, Node, O ) {
									window.popupExpired = new O.Dialog({
									      width: 365,
									      headerContent: '授权提示',
									      bodyContent: cont,
									      mask: true,
									      align: {
									          points: ['cc', 'cc']
									      },
									      closable :false,
									      draggable: true,
									      aria:true
									  });
									window.popupExpired.render();
									window.popupExpired.get('el').attr('id','J_MExpiredBox');
									window.popupExpired.show();
								})
							}
					}
		        },
		        complete: function (o,s,xhr) {  xhr = null; } 
		    });
	}	
	//getAuthTaskInfo();
	//过期了 判断是否还有任务
	var diff  = IsExpired();
	if(diff > 0){
		getAuthTaskInfo();
	}else{
		//没过期 设置定时器判断是否还有任务
		KISSY.later(getAuthTaskInfo,Math.abs(diff), false/*setInterval*/, null/*context*/, null);
	} 
})
</script>
</body>
</html>